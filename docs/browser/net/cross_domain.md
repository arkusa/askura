# Cross Domain

受**同源策略**限制, 对于我们不能在主站下访问外站的资源

> 当然 对于 &lt;img src="" /&gt; &lt;link href="" /&gt; 除外

但是, 有时我们需要打破这种限制...

## 跨域的方式

跨域主要有以下几种方式, 他们分别适用于不同的应用场景

### cookie追踪

- `jsonp`

我发现基本所有面试都会问到`jsonp`, 但是很少人会问你`jsonp`的应用场景

在我看来`jsonp`这种`hack 手段`, 想较于`server 代理`实在是过于鸡肋了, `server 代理`可以代替`jsonp`的所有应用场景, 这让我纠结了很久

直到不久前, 我在探究**Cookie**性质的时候, 我发现了它独一无二的应用场景 `Cookie 追踪`

---

它利用到了浏览器自动发送同源**Cookie**特性

🌰 

1.  你在A站搜索商品
2.  A 站将你 🔍 的内容通过`GET`请求发送到C 站
3.  此时 C 站将你浏览的商品 又种到了 C 域名的Cookie下
4.  当用户访问 B 站的时候, B站内嵌了一个请求 C 站的接口(`https://www.c.com/parse/cookie`)
5.  这个接口讲 C 域名下的 **Cookie** 解析, 然后通过 `jsonp`的方式传递给B站
6.  此时B 站 就能拿到 C站域名下的**Cookie**, 当然这个**Cookie**内存放了你在 A 站🔍 的内容

通过这种方式, 就可以做到设备 维度的用户追踪(不需要额外的库, 也不需要额外的关联信息user_id...)

因为浏览器是不允许我们访问/操作其他域名下的**Cookie**, 通过这种方式我们就能间接访问/操作三方域名下的**Cookie**

除了`jsonp`, 我没想到任何其他方式能够访问/操作其他域名下的**Cookie**, 当然这里指的是三方**Cookie**, 不包括父/子域名下的**Cookie**

`jsonp`再也不像个憨憨了

---

### 共享本地数据

- `iframe + (window.name / window.location.hash / postMessage)` 

共享数据一般都是为了实现用户在不同父/子域名下的免密登陆

1.  将父站 通过`iframe`嵌入到页面, 且隐藏
2.  登陆的时候, 我们将用户信息 存放到父域名的`localStorage`中 
3.  切换其他子站的时候, 如果子站也嵌入了父站的`iframe`就能够拿到上次存放的用户信息
4.  校验是否过期, 登陆

### 跨域API

- `server 代理`

一般都是通过`nginx`转发

当然你也可以适用任意后端语言实现自己的同源接口, 然后调用外站`API`

---

其中对用户隐藏的`server`叫做 **反向代理**

比如: `nginx`

对用户可见的方式叫做 **正向代理**

比如: `vpn`

### 标准化的跨域

- `cors`

值得一提的是`cors`除了发生在`xhr | fetch`外, 也发生在加载图片资源上

---

图片的跨域一般发生在将`img`绘制到`canvas`上, 并且导出`base64`

### WebSocket协议

浏览器同源策略的限制是作用在**HTTP协议**上的, 我们可以是用**WebSocket**来代替`xhr | fetch`

关于**WebSocket** 了解不够深入, 不清楚其优劣点, 比如会不会因为保持通话链接造成额外的服务端负载

TODO

## 链接

关于跨域方式的具体内容，可以参考

- [jsonp]()
- [iframe + (location.hash / window.name / postMessage)]()
- [cors]()
